{% extends "partials/base.html" %} {% load static %} 
{% block title %}Perfil - Trees Everywhere{% endblock %}
{% block content %}

<!-- CSS do Bootstrap -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />

<!-- CSS do Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />


<!-- JavaScript do Leaflet -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
    .sub-title {
        padding: 20px 0 15px 0;
        font-size: 18px;
        font-weight: 500;
        color: #012970;
        font-family: "Poppins", sans-serif;
    }

    #map-set {
            height: 550px;
            width: 100%;
        }
</style>


<div class="pagetitle">
  <h1>Perfil</h1>

</div>
<!-- End Page Title -->

<section class="section profile">
  <div class="row">
    <div class="col-xl-4">

        <div class="card">
          <div class="card-body profile-card pt-4 d-flex flex-column align-items-center">

            <img src="{% if profile_photo_link %}{{profile_photo_link}}{% else %}{% static 'assets/img/emptyProfile.png' %}{% endif %}" alt="Profile" class="rounded-circle" style="width: 120px; height: 120px;">
            <h2>{% if profile.name %}{{profile.name}}{% else %}{{profile.user.username}}{% endif %}</h2>
            {% if profile.country %}
              <h3>{{profile.country}}</h3>
            {% endif %}
            {% if profile.have_social_urls %}
              <div class="social-links mt-2">
                {% if profile.facebook %}
                  <a href="{{profile.facebook}}" class="facebook" target="_blank"><i class="bi bi-facebook"></i></a>
                {% endif %}
                {% if profile.instagram %}
                  <a href="{{profile.instagram}}" class="instagram" target="_blank"><i class="bi bi-instagram"></i></a>
                {% endif %}
                {% if profile.linkedin %}
                  <a href="{{profile.linkedin}}" class="linkedin" target="_blank"><i class="bi bi-linkedin"></i></a>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>

      </div>
    <div class="col-xl-8">
      <div class="card fixed-ratio">
        <div class="card-body pt-3">
          <!-- Bordered Tabs -->
          <ul class="nav nav-tabs nav-tabs-bordered">
            <li class="nav-item">
              <button
                id="overview-button"
                class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#profile-overview"
              >
                Geral
              </button>
            </li>

            <li class="nav-item">
              <button
                class="nav-link active"
                data-bs-toggle="tab"
                data-bs-target="#profile-maps"
              >
                Mapas
              </button>
            </li>

            <li class="nav-item">
              <button
                class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#profile-accounts"
              >
                Contas
              </button>
            </li>

            <li class="nav-item">
              <button
                class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#profile-edit"
              >
                Editar Perfil
              </button>
            </li>

          </ul>
          <div class="tab-content pt-2">
            
            <div class="tab-pane fade  profile-overview" id="profile-overview">
              <br>
              <a href="{% url 'register-planted-tree' %}">
                <button class="btn btn-primary btn-sm" title="Add Tree" style="color: white;"> 
                  <i class="bi bi-clipboard-plus-fill"></i> Registrar Árvore
                </button>
              </a>
              
              <hr>
              <div class="row mb-3">
                {% if planted_trees %}
                <p><strong>{{number_trees}} árvore(s) registrada(s).</strong></p>
                
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th scope="col">#ID</th>
                      <th scope="col">Descrição</th>
                      <th scope="col">Espécie</th>
                      <th scope="col">Data Plantio</th>
                      <th scope="col">Idade</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for arvore in planted_trees %}
                    <tr>
                      <th scope="row">{{arvore.id}}</th>
                      <td><a href="{% url 'edit-planted-tree' arvore.id %}">{{arvore.description}}</a></td>
                      <td>{{arvore.tree.scientific_name}}</td>
                      <td>{{arvore.planted_at_templ}}</td>
                      <td>{{arvore.age}}</td>
                    </tr>
                    {% endfor %}

                  </tbody>
                </table>
                {% else %}
                  <p><i>Nenhuma árvore registrada.</i></p>
                {% endif %}
              </div>
            </div>
            
            <div class="tab-pane show active fade pt-3" id="profile-maps">
              <!-- Maps -->
              <h5 class="sub-title">Mapa de Árvores Registradas</h5>
              <div id="map-set"></div>
              <!-- End Maps -->
            </div>

            <div class="tab-pane fade profile-edit pt-3" id="profile-edit">
              <!-- Profile Edit Form -->
              <form action="{% url 'profile' %}" id="profile-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="row mb-3">
                  {% if profile_form.errors %}
                    {% for field, errors in profile_form.errors.items %}
                      {% for error in errors %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                          <i class="bi bi-exclamation-octagon me-1"></i>
                          {{error}}
                          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                      {% endfor %}
                    {% endfor %}
                  {% endif %}
                </div>
                {% if not profile.google_account %}
                <div class="row mb-3">
                  <label
                    for="profileImage"
                    class="col-md-4 col-lg-3 col-form-label"
                    >Imagem de Perfil</label
                  >
                  <div class="col-md-8 col-lg-9">
                    <img
                        id="profileImage"
                        src="{% if profile_photo_link %}{{ profile_photo_link }}{% else %}{% static 'assets/img/emptyProfile.png' %}{% endif %}"
                        alt="Profile"
                        class="img-thumbnail"
                        style="max-width: 200px; max-height: 200px;"
                      />
                    <div class="pt-2">
                        <label for="id_profile_photo" class="btn btn-primary btn-sm" title="Upload new profile image" style="color: white; margin-bottom: 0;">
                            <i class="bi bi-upload"></i> Upload
                        </label>
                        {{profile_form.profile_photo}}
                        <button type="button" class="btn btn-danger btn-sm" title="Remove my profile image" onclick="clearPreviewAndInput()">
                          <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                {% endif %}
                <br>
                <div class="row mb-3">
                  <label for="fullName" class="col-md-4 col-lg-3 col-form-label"
                    >Nome</label
                  >
                  <div class="col-md-8 col-lg-9">
                    {{profile_form.name}}
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="about" class="col-md-4 col-lg-3 col-form-label"
                    >Sobre</label
                  >
                  <div class="col-md-8 col-lg-9">
                    {{profile_form.about}}
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Job" class="col-md-4 col-lg-3 col-form-label"
                    >Ocupação</label
                  >
                  <div class="col-md-8 col-lg-9">
                    {{profile_form.job}}
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Country" class="col-md-4 col-lg-3 col-form-label"
                    >País</label
                  >
                  <div class="col-md-8 col-lg-9">
                    {{profile_form.country}}
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Address" class="col-md-4 col-lg-3 col-form-label"
                    >Endereço Residencial</label
                  >
                  <div class="col-md-8 col-lg-9">
                    {{profile_form.address}}
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Phone" class="col-md-4 col-lg-3 col-form-label"
                    >Telefone</label
                  >
                  <div class="col-md-8 col-lg-9">
                    {{profile_form.phone}}
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Email" class="col-md-4 col-lg-3 col-form-label"
                    >E-mail</label
                  >
                  <div class="col-md-8 col-lg-9">
                    {{profile_form.email}}
                  </div>
                </div>


                <div class="row mb-3">
                  <label for="Facebook" class="col-md-4 col-lg-3 col-form-label"
                    >Perfil Facebook</label
                  >
                  <div class="col-md-8 col-lg-9">
                    {{profile_form.facebook}}
                  </div>
                </div>

                <div class="row mb-3">
                  <label
                    for="Instagram"
                    class="col-md-4 col-lg-3 col-form-label"
                    >Perfil Instagram</label
                  >
                  <div class="col-md-8 col-lg-9">
                    {{profile_form.instagram}}
                  </div>
                </div>

                <div class="row mb-3">
                  <label for="Linkedin" class="col-md-4 col-lg-3 col-form-label"
                    >Perfil LinkedIn</label
                  >
                  <div class="col-md-8 col-lg-9">
                    {{profile_form.linkedin}}
                  </div>
                </div>

                <div class="text-center">
                  <button type="submit" class="btn btn-primary">
                    Salvar
                  </button>
                </div>
              </form>
              <!-- End Profile Edit Form -->
            </div>

            <div class="tab-pane fade pt-3" id="profile-accounts">
              <!-- Maps -->
              <h5 class="sub-title">Contas Associadas</h5>
              <div class="row mb-3">
                {% if accounts %}
                <p><strong>{{number_accounts}} conta(s) associada(s).</strong></p>
                
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th scope="col">#ID</th>
                      <th scope="col">Nome</th>
                      <th scope="col">Número de Árvores Registradas</th>
                      <th scope="col">Membros Associados</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for conta in accounts %}
                    <tr>
                      <th scope="row">{{conta.id}}</th>
                      <td><a href="{% url 'account' conta.id %}">{{conta.name}}</a></td>
                      <td>{{conta.len_trees}} árvores</td>
                      <td>{{conta.len_members}} membros</td>
                    </tr>
                    {% endfor %}

                  </tbody>
                </table>
                {% else %}
                  <p><i>Você não está associado a nenhuma conta.</i></p>
                {% endif %}
              </div>
            </div>
              <!-- End Maps -->
            </div>

          </div>
          <!-- End Bordered Tabs -->
        </div>
      </div>
    </div>

    <div class="col-xl-3"></div>
  </div>
</section>

<!-- <script type="text/javascript">
  function refresh_summoner(id) {
      document.getElementById('refreshButton').disabled = true;
      $.ajax({
          type: 'GET',
          data: { 'id': id },
          url: "{% url 'index' %}",
          success: function (data) {
              console.log(data['response']);
          },
          error: function (xhr, status, error) {
              console.error('Erro na solicitação:', status, error);
          }
      });
  }
</script> -->

<script type="text/javascript">
  var profilePic = document.getElementById('profileImage');
  var inputFile = document.getElementById('id_profile_photo');
  var clearButton = document.getElementById('clear-preview');

  var reader = new FileReader();

  inputFile.onchange = function(){
    profilePic.src = URL.createObjectURL(inputFile.files[0]);
  }

  function clearPreviewAndInput() {
    profilePic.src = "{% static 'assets/img/emptyProfile.png' %}";
    inputFile.value = '';
  }


</script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
      // Verifique se há árvores plantadas e defina as coordenadas iniciais
      {% if planted_trees %}
          var latString = parseFloat('{{ planted_trees.0.latitude }}');
          var lngString = parseFloat('{{ planted_trees.0.longitude }}');
          var zoom = 13
      {% else %}
          var latString = parseFloat("-23.5505");
          var lngString = parseFloat("-46.6333");
          var zoom = 4
      {% endif %}

      // Inicialize o mapa
      var map = L.map('map-set').setView([latString, lngString], zoom); // Coordenadas de São Paulo, por exemplo

      // Adicione um tile layer (camada de mapa)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // Crie um grupo de camadas para os marcadores
      var markersGroup = L.layerGroup().addTo(map);

      // Adicione marcadores para cada árvore plantada
      {% if planted_trees %}
          {% for tree in planted_trees %}
              var lat = parseFloat('{{ tree.latitude }}');
              var lng = parseFloat('{{ tree.longitude }}');
              var marker = L.marker([lat, lng])
                  .bindPopup('{{ tree.description }} está aqui!')
                  .addTo(markersGroup);
          {% endfor %}
      {% endif %}

      // Garantir que o mapa seja redimensionado corretamente
      setTimeout(function() {
          map.invalidateSize();
          const overviewButton = document.getElementById('overview-button');
          overviewButton.click();
      }, 100);


  });
</script>



{% endblock %}
